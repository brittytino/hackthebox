generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PARTICIPANT
  ADMIN
}

enum RoundStatus {
  LOCKED
  ACTIVE
  COMPLETED
}

enum ChallengeLevel {
  LEVEL_1_1
  LEVEL_1_2
  LEVEL_1_3
  LEVEL_2_1
  LEVEL_2_2
  LEVEL_2_3
  LEVEL_3_1
  LEVEL_3_2
  LEVEL_3_3
}

// OTP System for Email Verification
model OTP {
  id            String        @id @default(uuid())
  email         String
  otpHash       String
  attempts      Int           @default(0)
  isVerified    Boolean       @default(false)
  expiresAt     DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([email])
  @@index([expiresAt])
}

// Team model with 2 mandatory members
model Team {
  id                String        @id @default(uuid())
  name              String        @unique
  email             String        @unique
  member1Name       String
  member2Name       String
  registrationTime  DateTime      @default(now())
  currentChallenge  ChallengeLevel @default(LEVEL_1_1)
  totalPoints       Int           @default(0)
  timeElapsed       Int           @default(0) // in seconds
  isActive          Boolean       @default(true)
  hintsUsed         Int           @default(0)
  submissions       Submission[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([name])
  @@index([email])
  @@index([totalPoints])
}

// Rounds (3 rounds total)
model Round {
  id            String        @id @default(uuid())
  roundNumber   Int           @unique // 1, 2, or 3
  title         String        // "THE BREACH DISCOVERY", "INFILTRATION", "THE FINAL STRIKE"
  theme         String        // "Cryptography & Code Breaking", etc.
  storyArc      String        @db.Text
  challenges    Challenge[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([roundNumber])
}

// Challenges (9 total: 3 per round)
model Challenge {
  id              String        @id @default(uuid())
  roundId         String
  round           Round         @relation(fields: [roundId], references: [id], onDelete: Cascade)
  level           ChallengeLevel @unique
  levelNumber     Int           // 1, 2, or 3 within the round
  title           String
  narrative       String        @db.Text
  challengeType   String
  difficulty      String        // "Easy", "Medium", "Hard"
  points          Int
  hintText        String?       @db.Text
  hintPenalty     Int           @default(0)
  maxAttempts     Int           @default(3)
  answerHash      String        // bcrypt hash of the correct answer
  isActive        Boolean       @default(true)
  submissions     Submission[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([roundId])
  @@index([level])
  @@index([levelNumber])
}

// Submission tracking
model Submission {
  id              String        @id @default(uuid())
  teamId          String
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  challengeId     String
  challenge       Challenge     @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  submittedAnswer String
  isCorrect       Boolean       @default(false)
  pointsAwarded   Int           @default(0)
  attemptNumber   Int           @default(1)
  timeTaken       Int           // in seconds from round start
  usedHint        Boolean       @default(false)
  createdAt       DateTime      @default(now())

  @@index([teamId])
  @@index([challengeId])
  @@index([isCorrect])
  @@index([createdAt])
}

// System configuration
model SystemConfig {
  id            String        @id @default(uuid())
  key           String        @unique
  value         String
  description   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([key])
}
